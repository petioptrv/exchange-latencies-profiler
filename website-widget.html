<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>World Latencies Map</title>

    <!-- amCharts v5 -->
    <script src="https://cdn.amcharts.com/lib/5/index.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/map.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/xy.js"></script>   <!-- ← NEW -->
    <script src="https://cdn.amcharts.com/lib/5/geodata/worldLow.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/themes/Animated.js"></script>

    <style>
        html,body{margin:0;height:100%}
        #chartdiv {width:100%;height:460px}
        #graphdiv {width:100%;height:260px}                         /* ← NEW */
        #menu{
            position:absolute;top:8px;left:8px;z-index:10;
            background:#fff;font:14px/1 sans-serif;padding:4px 6px;
            border-radius:6px;box-shadow:0 1px 4px rgba(0,0,0,.15)
        }
    </style>
</head>
<body>
<select id="menu"><option value="all">Show All</option></select>
<div id="chartdiv"></div>
<div id="graphdiv"></div>                                      <!-- ← NEW -->

<script>
    /* ---------- 1. DATA ---------- */
    const raw = [
        { title:"JFK (New York)", coords:[-73.778137, 40.641312],
            category:"North America", latency:"17 ms",
            graph:[[1,2],[2,3],[3,4],[4,3],[5,7]]
        },
        { title:"LHR (London)",   coords:[-0.454296, 51.470020],
            category:"Europe", latency:"23 ms",
            graph:[[1,3],[2,4],[3,3],[4,4],[5,6]]
        },
        { title:"PEK (Beijing)",  coords:[116.597504, 40.072498],
            category:"Asia", latency:"44 ms",
            graph:[[1,1],[2,2],[3,3],[4,2],[5,3]]
        }
    ];
    const points = raw.map(p => ({ ...p, geometry:{type:"Point", coordinates:p.coords} }));

    /* ---------- 2. MAP ---------- */
    am5.ready(function(){

        /* ----- Map ----- */
        const mapRoot = am5.Root.new("chartdiv");
        mapRoot.setThemes([am5themes_Animated.new(mapRoot)]);

        const chart = mapRoot.container.children.push(
            am5map.MapChart.new(mapRoot,{panX:"rotateX",panY:"rotateY",
                wheelX:"zoom",wheelY:"zoom",projection:am5map.geoEqualEarth()})
        );

        const polygonSeries = chart.series.push(
            am5map.MapPolygonSeries.new(mapRoot,{
                geoJSON:am5geodata_worldLow, exclude:["AQ"],
                fill:am5.color(0x6fc5a2), stroke:am5.color(0x4e9477)
            }));
        polygonSeries.mapPolygons.template.setAll({strokeOpacity:.6,fillOpacity:.8});

        /* ---------- 3. GRAPH ---------- */
        const gRoot = am5.Root.new("graphdiv");
        gRoot.setThemes([am5themes_Animated.new(gRoot)]);

        const gChart = gRoot.container.children.push(
            am5xy.XYChart.new(gRoot,{panX:true,panY:true,wheelX:"zoomX",wheelY:"zoomY"})
        );

        const xAxis = gChart.xAxes.push(
            am5xy.ValueAxis.new(gRoot,{renderer:am5xy.AxisRendererX.new(gRoot,{})})
        );
        const yAxis = gChart.yAxes.push(
            am5xy.ValueAxis.new(gRoot,{renderer:am5xy.AxisRendererY.new(gRoot,{})})
        );

        const lineSeries = gChart.series.push(
            am5xy.LineSeries.new(gRoot,{
                xAxis:xAxis,
                yAxis:yAxis,
                valueXField:"x", 
                valueYField:"y",
                stroke:am5.color(0x006cff),
                strokeWidth:2
            })
        );
        
        lineSeries.bullets.push(function() {
            return am5.Bullet.new(gRoot, {
                sprite: am5.Circle.new(gRoot, {
                    radius: 3,
                    fill: am5.color(0x006cff)
                })
            });
        });

        /* helper to load graph data */
        function updateGraph(title,pairs){
            const graphData = pairs.map(([x,y])=>({x,y}));
            lineSeries.data.setAll(graphData);
        }
        updateGraph(points[0].title,points[0].graph);   // initial graph

        const pointSeries = chart.series.push(am5map.MapPointSeries.new(mapRoot,{}));

        pointSeries.bullets.push((root,dataItem)=>{
            const sprite = am5.Circle.new(root,{
                radius:5, fill:am5.color(0x006cff),
                stroke:am5.color(0xffffff), strokeWidth:1,
                tooltipText:"{title}\nLatency: {latency}"
            });

            /* click → update graph */
            sprite.events.on("click", function (ev) {
                // Get current series data and find the matching point
                const seriesData = pointSeries.data.values;
                
                // Try to find by checking the dataItem's position in the series
                const dataItems = pointSeries.dataItems;
                const bulletIndex = dataItems.indexOf(ev.target.dataItem);
                
                const pointData = seriesData[bulletIndex];
                updateGraph(pointData.title, pointData.graph);
            });

            return am5.Bullet.new(root,{sprite});
        });

        pointSeries.data.setAll(points);

        /* ----- Filter menu ----- */
        const menu = document.getElementById("menu");
        [...new Set(points.map(p=>p.category))].sort().forEach(cat=>{
            const o=document.createElement("option"); o.value=cat;o.textContent=cat;menu.appendChild(o);
        });
        menu.addEventListener("change",()=>{
            const sel=menu.value;
            pointSeries.data.setAll(sel==="all"?points:points.filter(p=>p.category===sel));
        });
    });
</script>
</body>
</html>
